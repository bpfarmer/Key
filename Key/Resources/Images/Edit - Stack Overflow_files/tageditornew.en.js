"use strict";StackExchange.tagEditor=function(e,t,n,i){function r(){_=!0}function a(){if("undefined"==typeof B){for(var e=StackExchange.tagEditor.requiredTags,t=[],n=0;n<e.length;n++)t.push(e[n].Name.replace(/[.+]/g,"\\$&"));B=new RegExp("^(?:"+t.join("|")+")$")}return B}function o(){var e=StackExchange.tagEditor.requiredTags;if(e&&/^ ?$/.test(U.val())){var t=a();0===N.add(H).children().filter(function(){return t.test($(this).text())}).length&&w(StackExchange.tagEditor.requiredTags)}}function s(e,t){var n=window.tagRendererRaw(e,null,"span"),i=$(n);return t||(i.append($("<span>",{"class":"delete-tag","title":"remove this tag"})),D.trigger("tagSpanCreated",[i])),i}function l(e){var t=$([]),n=$([]);switch(e){case J.all:t=N.find(".post-tag"),n=H.find(".post-tag");break;case J.left:t=N.find(".post-tag:last");break;case J.right:n=H.find(".post-tag:first");break;case J.all_left:t=N.find(".post-tag");break;case J.all_right:n=H.find(".post-tag")}return{"pre":t,"post":n}}function c(e){e=e||J.all;var t=l(e),n=t.pre.map(function(e,t){return $(t).text()}).get().join(" ");n.length&&(n+=" ");var i=t.post.map(function(e,t){return $(t).text()}).get().join(" ");return i.length&&U.val().length&&(i=" "+i),{"text":n+U.val()+i,"lengthBeforeInput":n.length}}function u(){var e=U.val();return(""===e||" "===e)&&0===N.add(H).children().filter(function(){return!/^\s*$/.test($(this).text())}).length}function d(e){e=e||J.all;var t=U.caret(),n=U[0].selectionDirection,i=l(e);if(i.pre.add(i.post).length){var r=c(e);U.val(r.text),i.pre.remove(),i.post.remove(),U.caret(t.start+r.lengthBeforeInput,t.end+r.lengthBeforeInput),P&&(U[0].selectionDirection=n),E()}}function f(t){if(!z){var n;if(n=t?{"start":U.val().length,"end":U.val().length}:U.caret(),-1==n.start&&(n.start=n.end=0),!P&&n.start!==n.end)return d(),m(),void 0;var i=U.val(),r=i.substr(0,n.start),a=i.substr(n.end),l=U[0].selectionDirection,f=(r+"!").split(/[,;\s]+/);f[f.length-1]="!"===f[f.length-1]?"":f[f.length-1].slice(0,-1);var h=a.split(/[,;\s]+/),p=f.pop(),g=p.length;p+=i.substring(n.start,n.end),p+=h.shift(),f=sanitizeAndSplitTags(f.join(" ")),h=sanitizeAndSplitTags(h.join(" "));var v;for(v=0;v<f.length;v++)s(f[v]).appendTo(N);for(v=0;v<h.length;v++)s(h[v]).appendTo(H);p!==U.val()&&U.val(p);var b={};D.find(".post-tag").filter(function(){var e=$(this).text();return/^\s*$/.test(e)?!0:b[e]===!0?!0:(b[e]=!0,!1)}).remove();var y=c().text;y!=e.val()&&(e.val(y).trigger("change"),StackExchange.MarkdownEditor&&styleCode.updateLangdivDelayed.trigger(y.split(/ /g))),_&&(U.caret(g,g+n.end-n.start),P&&(U[0].selectionDirection=l),x(),o()),m(),!_&&u()?U.attr("placeholder",L):U.attr("placeholder","")}}function h(e,t){var n,i;if("string"==typeof e)i=e;else{if(!e.length)return;n=e,i=n.text()}for(var r=sanitizeAndSplitTags(U.val()),a=0;a<r.length;a++)s(r[a]).appendTo(N);if(U.val(i),n){var o=$($.unique(n.prevAll(".post-tag").get()));n.nextAll(".post-tag").prependTo(H),o.appendTo(N),n.remove()}else H.find(".post-tag").appendTo(N);U.focus(),t&&U.caret(0,0)}function p(e){var t=e.val(),n="c_"+t;if(n in X)return X[n];var i=$("<span />").css("font-family",e.css("font-family"));i.text(e.val()),i.insertAfter(e);var r=i.innerWidth();return i.remove(),X[n]=r,r}function g(e){e!==Y&&(N.add(U).add(H).css({"position":"relative","left":e}),Y=e)}function m(){var e=p(U)+19,t=N.outerWidth();return H.children().length||(e=Math.max(e,O-t-8)),U.css("width",e),t+Y>0&&O>t+Y+e?void 0:O>t+e?(g(0),void 0):(g(-t+(O-e)/2),void 0)}function v(){K=!0,setTimeout(function(){K=!1},0)}function b(e){if(!P&&e.shiftKey&&Z[e.which]||e.ctrlKey&&65===e.which)return d(),!0;var t,n,i=U.caret(),r=U[0].selectionDirection,a="forward"===r?i.end:i.start,o=a===U.val().length,s=0===a;switch(e.which){case 37:return s?(t=N.find(".post-tag:last"),t.length?(e.shiftKey?d(J.left):h(t),e.shiftKey):!0):!0;case 39:return o?(n=H.find(".post-tag:first"),n.length?(e.shiftKey?d(J.right):h(n,!0),e.shiftKey):!0):!0;case 8:return s?(t=N.find(".post-tag:last"),t.length?(U.val(t.text()+U.val()),U.caret(t.text().length,t.text().length),t.remove(),!1):!0):!0;case 46:return o?(n=H.find(".post-tag:first"),n.length?(U.val(U.val()+n.text()),U.caret(a,a),n.remove(),!1):!0):!0;case 36:case 38:return t=N.find(".post-tag:first"),t.length?(e.shiftKey?d(J.all_left):h(t,!0),e.shiftKey):!0;case 40:var l=$(".tag-suggestions > div:first");if(l.length)return v(),l.focus(),!1;case 35:return n=H.find(".post-tag:last"),n.length?(e.shiftKey?d(J.all_right):h(n),e.shiftKey):!0;case 9:v();break;case 27:E(),e.preventDefault(!0);break;case 13:if($(".tag-suggestions").length)return!1}return!0}function y(e){var t=e.find("p.more-info");"undefined"==typeof Q&&(Q=R-5-t.outerWidth());var n=e.find(".post-tag:first").outerWidth()+e.find(".item-multiplier").outerWidth();n>Q&&t.find("a").text("info")}function w(e,t){$(".tag-suggestions").remove(),z=!1;var n=e.length;if(0!==n){var i=$("<div class='tag-suggestions' />").css({"position":"absolute","left":D.position().left,"top":D.position().top+j+1,"width":O-10}).insertAfter(D),r={};D.find(".post-tag").each(function(){r[$(this).text()]=!0});for(var a=0;a<e.length;a++)if(r[e[a].Name]!==!0){var o=k(e[a],t).appendTo(i).attr("tabindex",F||0);y(o),a%M===0&&o.css("clear","both")}i.delegate("div","keydown",T),i.delegate("div","click",function(e){$(e.target).is("a")||C($(this))}),i.delegate("div","focus",function(){K&&1===n?C($(this)):z=!0}),i.delegate("div","blur",function(){z=!1})}}function x(){var e=sanitizeAndSplitTags(U.val())[0];if(G!==e)return G=e,e&&e.length?(S(e,function(t){e===G&&_&&w(t,e)}),void 0):(E(),void 0)}function k(e,t){var n=$("<div />").css("width",R).data("tag-name",e.SynonymOf||e.Name);t&&(t=t.replace(/-/g,"").replace(/(.)(?=.)/g,"$1-*").replace(/\+/g,"\\+").replace(/\./g,"\\."));var i=s(e.Name,!0),r=i.html();if(t&&(r=r.replace(new RegExp("("+t+")"),"<span class='match'>$1</span>")),n.append(i.html(r)),e.Count&&n.append($("<span class='item-multiplier' />").html("&times;&nbsp;"+e.Count)),A){var a="";if(e.Excerpt&&(a=e.Excerpt),a.length&&n.append($("<p />").text(a)),e.Synonyms&&e.Synonyms.length)for(var o=$("<p >also:</p>").appendTo(n),l=e.Synonyms.split(/\|/),c=0;c<l.length;c++)a=l[c],t&&(a=a.replace(new RegExp("("+t+")"),"<span class='match'>$1</span>")),c>0&&(a=", "+a),o.append("<span>"+a+"</span>")}return n.append("<p class='more-info'><a href='/tags/"+encodeURIComponent(e.SynonymOf||e.Name)+"/info' target='_blank'>learn more</a></p>"),n}function S(e,t){et["t_"+e]?t(et["t_"+e]):tt.trigger(e,t)}function C(e){U.val(e.data("tag-name")),E(),h(""),f()}function E(){$(".tag-suggestions").remove(),z=!1,tt.cancel()}function T(e){var t;switch(e.which){case 39:case 40:return $(this).next("div").focus(),!1;case 37:return $(this).prev("div").focus(),!1;case 38:return t=$(this).prev("div"),t.length?t.focus():U.focus(),!1;case 27:return E(),U.focus(),!1;case 13:case 32:return C($(this)),!1}}var _;if("undefined"==typeof n)try{_=e.is(":focus")}catch(I){_=!1}else _=n;if(e.bind("focus",r),!e.is(":visible"))return t=t||0,3>t?(setTimeout(function(){e.unbind("focus",r),StackExchange.tagEditor(e,t+1,_)},300),void 0):(e.unbind("focus",r),$("body.review-task-page").length||StackExchange.debug.log("tag box is invisible, couldn't start tag editor"),void 0);i||(i={});var M=i.columns||3,A="undefined"==typeof i.excerpts||i.excerpts,L=e.attr("placeholder")||"";e.unbind("focus",r);var O=e.innerWidth(),R=(O-40)/M|0,D=$("<div class='tag-editor' />").css("width",O).insertAfter(e),P="selectionDirection"in e[0];e.hide();var q=$("<span class='post-tag'>test</span>").appendTo(D),j=D.innerHeight();q.remove(),D.css("height",j);var N=$("<span />").appendTo(D),U=$("<input type='text' tabIndex='0'/>").appendTo(D).val(e.val()+" ").attr("placeholder",L),H=$("<span />").appendTo(D),F=e.attr("tabIndex");F&&U.attr("tabIndex",F);var B,z=!1,W=_;U.focus(function(t,n){_=!0,o(),W||(n||e.triggerHandler("focus",!0),W=!0)});var V=!1;D.mousedown(function(){V=!0,$(document).one("mouseup",function(){setTimeout(function(){_||(e.triggerHandler("blur"),W=!1),V=!1},0)})}),U.blur(function(){_=!1,setTimeout(function(){z||(E(),f(),V||(e.triggerHandler("blur"),W=!1)),V=!1},0)}),e.focus(function(e,t){t||U.trigger("focus",!0)}),U.keydown(b),U.bind("keydown paste click change",function(){setTimeout(function(){f()},0)}),D.delegate(".post-tag","click",function(e){var t=$(this);$(e.target).hasClass("delete-tag")&&t.text(""),h(t),f()}),D.click(function(e){e.target===this&&(h(""),f())}),D.on("rerender",function(){d(),f(!0)});var K,G,Q,J={"left":1,"right":2,"all_left":3,"all_right":4,"all":5},X={},Y=0,Z={"35":!0,"36":!0,"37":!0,"38":!0,"39":!0,"40":!0},et={},tt=StackExchange.helpers.DelayedReaction(function(e,t){StackExchange.helpers.addSpinner(D,{"position":"absolute","right":10,"top":j/2-2}),$.get("/filter/tags",{"q":e,"newstyle":!0},"json").done(function(n){et["t_"+e]=n,StackExchange.helpers.removeSpinner(),t(n)})},400,{"sliding":!0});f(!0),StackExchange.helpers.genericBindOverlayEvents(D,U,u),StackExchange.tagEditor.ready.resolve(),e[0].func_clear=function(){e.val(""),U.val("").blur(),D.find(".post-tag").remove()},e[0].func_add=function(e){var t=U.val();U.val(e),h(t),f()}},StackExchange.tagEditor.ready=$.Deferred();